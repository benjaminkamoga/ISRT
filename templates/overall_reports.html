<!-- overall_reports.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Overall Reports</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
body { font-family: Arial, sans-serif; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #333; padding: 6px; vertical-align: top; }
th { background-color: #eee; }
tr:nth-child(even) { background-color: #f9f9f9; }
.min-table { border: 1px solid #333; border-collapse: collapse; width: 100%; margin-top: 5px; }
.min-table th, .min-table td { border: 1px solid #333; padding: 4px; }
</style>
</head>
<body>
<div class="container mt-3">

<h2>Overall Inspections Conducted in Southern Zone</h2>

<!-- Filter Form -->
<form id="filterForm" class="row g-3 mb-3">
  <div class="col-md-3">
    <label for="inspectionType" class="form-label">Inspection Type</label>
    <select id="inspectionType" class="form-select">
      <option value="">All</option>
      {% for insp_type in inspection_types %}
      <option value="{{ insp_type }}">{{ insp_type }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label for="region" class="form-label">Region</label>
    <select id="region" class="form-select">
      <option value="">All</option>
      {% for reg in regions %}
      <option value="{{ reg }}">{{ reg }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label for="district" class="form-label">District</label>
    <select id="district" class="form-select">
      <option value="">All</option>
      {% for dist in districts %}
        <option value="{{ dist.name }}" data-region="{{ dist.region }}">{{ dist.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3 align-self-end d-flex align-items-center gap-2">
    <button type="button" id="resetFilter" class="btn btn-secondary">Reset</button>
    <span id="resultCount" class="badge bg-primary" style="font-size:14px; display:none;">
      Total Results: 0
    </span>
  </div>
</form>

{% if inspections %}
{% set defect_name_map = {
    'gotMedicines': 'GOT Medicines',
    'unregisteredMedicines': 'Unregistered Medicines',
    'noQualifiedPersonnel': 'No Qualified Personnel',
    'minimalRequirements': 'Premise Meets Minimal Requirements',
    'unregisteredPremise': 'Unregistered Premises'
} %}

{% set aggregated = {} %}
{% for insp in inspections %}
  {% set oid = insp.overall_id %}
  {% if aggregated[oid] is not defined %}
    {% set _ = aggregated.update({oid: {
      'daily_ids':[insp.daily_id],
      'summary': insp.summary,
      'premises_data': insp.premises_data | default({}),
      'defects_data': insp.defects_data | default({}),
      'charges_data': insp.charges_data | default({'total':0,'got_value':0,'unregistered_value':0,'dldm_value':0}),
      'recall_products':[insp.recall_product_data] if insp.recall_product_data is defined else [],
      'dates':[insp.date]
    }}) %}
  {% else %}
    {% set _ = aggregated[oid].daily_ids.append(insp.daily_id) %}
    {% set _ = aggregated[oid].dates.append(insp.date) %}
    {% for k,v in (insp.premises_data or {}).items() %}
      {% if aggregated[oid].premises_data[k] is defined %}
        {% set _ = aggregated[oid].premises_data.update({k: aggregated[oid].premises_data[k]+v}) %}
      {% else %}
        {% set _ = aggregated[oid].premises_data.update({k:v}) %}
      {% endif %}
    {% endfor %}
    {% for k,v in (insp.defects_data or {}).items() %}
      {% if aggregated[oid].defects_data[k] is defined %}
        {% for defect_key, defect_count in v.items() %}
          {% if aggregated[oid].defects_data[k][defect_key] is defined %}
            {% set _ = aggregated[oid].defects_data[k].update({defect_key: aggregated[oid].defects_data[k][defect_key]+defect_count}) %}
          {% else %}
            {% set _ = aggregated[oid].defects_data[k].update({defect_key: defect_count}) %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% set _ = aggregated[oid].defects_data.update({k:v}) %}
      {% endif %}
    {% endfor %}
    {% for k,v in (insp.charges_data or {}).items() %}
      {% if aggregated[oid].charges_data[k] is defined %}
        {% set _ = aggregated[oid].charges_data.update({k: aggregated[oid].charges_data[k]+v}) %}
      {% else %}
        {% set _ = aggregated[oid].charges_data.update({k:v}) %}
      {% endif %}
    {% endfor %}
    {% if insp.recall_product_data is defined %}
      {% set _ = aggregated[oid].recall_products.append(insp.recall_product_data) %}
    {% endif %}
  {% endif %}
{% endfor %}

<table class="table table-bordered table-responsive">
<thead>
<tr>
<th>S/No</th>
<th>Inspection Name</th>
<th>Inspection Type</th>
<th>Region</th>
<th>District</th>
<th>View Summary</th>
<th>Official Report</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for oid, agg in aggregated.items() %}
<tr>
<td>{{ loop.index }}</td>
<td>
{% set sorted_dates = agg.dates | sort %}
{{ agg.summary.inspection_type }} conducted in {{ agg.summary.district }} - {{ agg.summary.region }}
{% if sorted_dates|length>0 %}
 on {{ sorted_dates[0]|string }}{% if sorted_dates|length>1 %} to {{ sorted_dates[-1]|string }}{% endif %}
{% endif %}
</td>
<td>{{ agg.summary.inspection_type or 'NA' }}</td>
<td>{{ agg.summary.region or 'NA' }}</td>
<td>{{ agg.summary.district or 'NA' }}</td>

<!-- View Summary Modal -->
<td>
<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modal{{ loop.index }}">View</button>

<div class="modal fade" id="modal{{ loop.index }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-xl modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
Summary of {{ agg.summary.inspection_type }} conducted in {{ agg.summary.district }} - {{ agg.summary.region }}
{% if sorted_dates|length>0 %}
 on {{ sorted_dates[0]|string }}{% if sorted_dates|length>1 %} to {{ sorted_dates[-1]|string }}{% endif %}
{% endif %}
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">

<!-- Premises Data -->
<!-- Premises Data -->
{% if agg.premises_data %}
  {% set premise_totals = {} %}
  {% for ptype, count in agg.premises_data.items() %}
    {% set cleaned = ptype.strip().lower() %}
    {% if premise_totals[cleaned] is defined %}
      {% set _ = premise_totals.update({cleaned: premise_totals[cleaned] + count}) %}
    {% else %}
      {% set _ = premise_totals.update({cleaned: count}) %}
    {% endif %}
  {% endfor %}

  {% set total_premises = premise_totals.values() | sum %}

  <h6 class="bg-light p-2 rounded mt-3"><strong>Premises Inspected</strong></h6>
  <p>
    During this inspection, a total of <strong>{{ total_premises }}</strong> premises were inspected, with a breakdown as follows:
  </p>

  <table class="min-table">
    <thead>
      <tr><th>Premise Type</th><th>Count</th></tr>
    </thead>
    <tbody>
    {% for k, v in premise_totals.items() if v > 0 %}
      <tr><td>{{ k|title }}</td><td>{{ v }}</td></tr>
    {% endfor %}
    </tbody>
  </table>
{% endif %}


<!-- Observations -->
{# Canonical mapping: all variants mapped to unified keys #}
{% set canonical_key_map = {
    'GOT Medicines': 'got_medicines',
    'gotMedicines': 'got_medicines',
    'Premises Found with GOT Medicines': 'got_medicines',

    'Premise Meets Minimal Requirements': 'minimal_requirements',
    'minimalRequirements': 'minimal_requirements',
    'Premises Do Not Meet Minimal General Requirements(GSP)': 'minimal_requirements',

    'Unregistered Premises': 'unregistered_premises',
    'unregisteredPremise': 'unregistered_premises',

    'Unregistered Medicines': 'unregistered_medicines',
    'unregisteredMedicines': 'unregistered_medicines',
    'Premises Found with Unregistered Medicine': 'unregistered_medicines',

    'No Qualified Personnel': 'no_qualified_personnel',
    'noQualifiedPersonnel': 'no_qualified_personnel',
    'Premises With No Qualified Personnel': 'no_qualified_personnel',

    'dldmNotAllowed': 'dldm_not_allowed',
    'DLDM Not Allowed Medicines': 'dldm_not_allowed',
    'Premise Found with DLDM NOT ALLOWED MEDICINES': 'dldm_not_allowed',

    'medicalPractices': 'medical_practices',
    'Medical Practices': 'medical_practices',
    'Medical Practices Violation Premises': 'medical_practices'
} %}

{# Display labels for the canonical keys #}
{% set label_map = {
    'got_medicines': 'Premises Found with GOT Medicines',
    'minimal_requirements': 'Premises Do Not Meet Minimal General Requirements(GSP)',
    'unregistered_premises': 'Unregistered Premises',
    'unregistered_medicines': 'Premises Found with Unregistered Medicine',
    'no_qualified_personnel': 'Premises With No Qualified Personnel',
    'dldm_not_allowed': 'Premise Found with DLDM NOT ALLOWED MEDICINES',
    'medical_practices': 'Medical Practices Violation Premises'
} %}

{# Aggregate observations across all premises #}
{% set all_observations = {} %}

{% for ptype, defects in agg.defects_data.items() %}
  {% for key, count in defects.items() %}
    {% if count > 0 %}
      {% set canonical_key = canonical_key_map.get(key, key) %}
      {% set label = label_map.get(canonical_key, canonical_key) %}
      {% if all_observations[canonical_key] is not defined %}
        {% set _ = all_observations.update({
          canonical_key: {
            'label': label,
            'total': count,
            'breakdown': {ptype: count}
          }
        }) %}
      {% else %}
        {% set existing = all_observations[canonical_key] %}
        {% set new_breakdown = existing.breakdown.copy() %}
        {% set _ = new_breakdown.update({
          ptype: new_breakdown.get(ptype, 0) + count
        }) %}
        {% set _ = all_observations.update({
          canonical_key: {
            'label': label,
            'total': existing.total + count,
            'breakdown': new_breakdown
          }
        }) %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endfor %}

{# Output the Observations Table #}
{% if all_observations|length > 0 %}
  <h6 class="bg-light p-2 rounded mt-3"><strong>Observations Identified</strong></h6>
  <p>The following observations were identified during inspection:</p>
  <table class="min-table">
    <thead>
      <tr>
        <th>Observation</th>
        <th>Total</th>
        <th>Breakdown by Premise</th>
      </tr>
    </thead>
    <tbody>
      {% for key, data in all_observations.items() %}
        <tr>
          <td>{{ data.label }}</td>
          <td>{{ data.total }}</td>
          <td>
            {% for ptype, count in data.breakdown.items() %}
              {{ ptype }} {{ count }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}



<!-- Actions Taken -->
<!-- Actions Taken -->
<h6 class="bg-light p-2 rounded mt-3"><strong>Actions Taken</strong></h6>
<ul>
{% set action_map = {
  'got_medicines': 'The GOT Medicines / Medical Devices were confiscated. The owners were instructed to pay Disposal Fee + 2/3*Tsh 500,000/= as fine liable for selling GOT Products in private Facility. Likewise, they were given warning.',
  'unregistered_medicines': 'The Unregistered Medicines / Medical Devices were confiscated. The owners were instructed to pay Disposal Fee + 2% FOB of total product value + 2/3*Tsh 500,000/= as fine liable for selling Unregistered Products in their facilities.',
  'no_qualified_personnel': 'For the premises with no Qualified personnel, the owners were instructed to hire qualified staff before proceeding to provide services.',
  'minimal_requirements': 'For Facilities which do not meet good GMP e.g. hygiene and premise air circulation, they were advised to upgrade to meet regulatory standards.',
  'unregistered_premises': 'For Unregistered Premises, operations were halted until registration is completed.',
  'dldm_not_allowed': 'DLDM NOT ALLOWED MEDICINES were confiscated and ownwers were instructed to pay 25% of total product value for disposal.',
  'medical_practices': 'For Premises found conducting Medical practices against the law, strict warning issued; follow-up required.'
} %}

{% set listed = [] %}
{% for key in all_observations.keys() %}
  {% if key in action_map and key not in listed %}
    <li>{{ action_map[key] }}</li>
    {% set _ = listed.append(key) %}
  {% endif %}
{% endfor %}
<li>Education was given to all staffs/owners of premise inspected to ensure that they strictly abide to the Laws, Rules and Regulation of Authority.</li>
</ul>



{% if 'recall' in (agg.summary.inspection_type | lower) %}
<!-- Recalled Products -->
<h6 class="bg-light p-2 rounded mt-3"><strong>Recalled Products</strong></h6>

{% set merged_products = {} %}

{# Merge all recalled products #}
{% for recall_set in agg.recall_products %}
    {% if recall_set is defined %}
        {% set all_products = recall_set.get('recalled_products', []) %}

        {% for facility_type, cat_data in recall_set.items() %}
            {% if facility_type != "recalled_products" %}
                {% set items = [] %}

                {# Use products_found if present, else fallback to recalled_products #}
                {% if cat_data.products_found is defined and cat_data.products_found|length > 0 %}
                    {% set items = cat_data.products_found %}
                {% elif all_products|length > 0 %}
                    {% set items = all_products %}
                {% endif %}

                {% for item in items %}
                    {% if item.product_index is defined and item.batch_index is defined and all_products %}
                        {% set product = all_products[item.product_index] %}
                        {% set batch = product.batches[item.batch_index] %}
                    {% else %}
                        {% set product = item %}
                        {% set batch = item.batches[0] if item.batches is defined and item.batches|length > 0 else {'batchNumber':'N/A','manufactureDate':'N/A','expiryDate':'N/A'} %}
                    {% endif %}

                    {% set key = product.brandName ~ '|' ~ product.genericName ~ '|' ~ product.manufacturer ~ '|' ~ batch.batchNumber ~ '|' ~ product.reason %}

                    {% if merged_products[key] is not defined %}
                        {% set _ = merged_products.update({key: {
                            'brandName': product.brandName,
                            'genericName': product.genericName,
                            'manufacturer': product.manufacturer,
                            'batchNumber': batch.batchNumber,
                            'mfd': batch.manufactureDate,
                            'exp': batch.expiryDate,
                            'reason': product.reason,
                            'value': item.value or 0,
                            'quantity': item.quantity or 0,
                            'premises_total': item.premises or 0,
                            'premises_breakdown': {facility_type: item.premises or 0}
                        }}) %}
                    {% else %}
                        {% set existing = merged_products[key] %}
                        {% set updated_breakdown = existing.premises_breakdown.copy() %}
                        {% set _ = updated_breakdown.update({facility_type: updated_breakdown.get(facility_type, 0) + (item.premises or 0)}) %}
                        {% set _ = merged_products.update({key: {
                            'brandName': existing.brandName,
                            'genericName': existing.genericName,
                            'manufacturer': existing.manufacturer,
                            'batchNumber': existing.batchNumber,
                            'mfd': existing.mfd,
                            'exp': existing.exp,
                            'reason': existing.reason,
                            'value': existing.value + (item.value or 0),
                            'quantity': existing.quantity + (item.quantity or 0),
                            'premises_total': existing.premises_total + (item.premises or 0),
                            'premises_breakdown': updated_breakdown
                        }}) %}
                    {% endif %}
                {% endfor %}

            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}

{# Display Table #}
<table class="min-table mt-2">
    <thead>
        <tr>
            <th>S/No</th>
            <th>Brand</th>
            <th>Generic</th>
            <th>Manufacturer</th>
            <th>Batch</th>
            <th>MFD</th>
            <th>EXP</th>
            <th>Reason</th>
            <th>Premises</th>
            <th>Value (Tsh)</th>
            <th>Quantity</th>
        </tr>
    </thead>
    <tbody>
        {% for key, p in merged_products.items() %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ p.brandName }}</td>
            <td>{{ p.genericName }}</td>
            <td>{{ p.manufacturer }}</td>
            <td>{{ p.batchNumber }}</td>
            <td>{{ p.mfd }}</td>
            <td>{{ p.exp }}</td>
            <td>{{ p.reason }}</td>
            <td>
                {{ p.premises_total }} (
                {% for ft, val in p.premises_breakdown.items() if val > 0 %}
                    {{ ft }} {{ val }}{% if not loop.last %}, {% endif %}
                {% endfor %}
                )
            </td>
            <td>{{ p.value }}</td>
            <td>{{ p.quantity }}</td>
        </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <th colspan="9" class="text-end">Total</th>
            <th>{{ merged_products.values() | map(attribute='value') | sum }}</th>
            <th>{{ merged_products.values() | map(attribute='quantity') | sum }}</th>
        </tr>
    </tfoot>
</table>
{% endif %}




{% if agg.summary.inspection_type != "Recall Inspection" %}
<!-- Charges -->
<h6 class="bg-light p-2 rounded mt-3"><strong>Charges & Confiscated Values</strong></h6>

{% set got_value = agg.charges_data.got_value | default(0) %}
{% set unregistered_value = agg.charges_data.unregistered_value | default(0) %}
{% set dldm_value = agg.charges_data.dldm_value | default(0) %}
{% set total_product_worth = got_value + unregistered_value + dldm_value %}
{% set total_charges = agg.charges_data.total | default(0) %}

<ul>
  <li>
    During this inspection, a total of <strong>{{ total_charges }} Tsh</strong> was collected due to various offences committed.
  </li>
  <li>
    Also, products worth <strong>{{ total_product_worth }} Tsh</strong> were confiscated as the following table shows:
  </li>
</ul>

<table class="min-table">
  <thead>
    <tr>
      <th>Type</th>
      <th>Value (Tsh)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Value of GOT Products</td>
      <td>{{ got_value }}</td>
    </tr>
    <tr>
      <td>Value of Unregistered Products</td>
      <td>{{ unregistered_value }}</td>
    </tr>
    <tr>
      <td>Value of DLDM Not Allowed Medicines</td>
      <td>{{ dldm_value }}</td>
    </tr>
  </tbody>
</table>
{% endif %}


</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>
</td>

<!-- Official Report Upload/Download Column -->
<td>
  <!-- Button Group for Download + Edit -->
  <div id="uploadStatus{{ loop.index }}" class="btn-group" role="group">
    {% if agg.summary.official_report %}
      <a href="{{ url_for('download_report', filename=agg.summary.official_report) }}"
         class="btn btn-success btn-sm"
         download>
        Download
      </a>
      <button type="button"
              class="btn btn-outline-secondary btn-sm"
              onclick="document.getElementById('fileInput{{ loop.index }}').click();">
        <i class="bi bi-pencil"></i>
      </button>
    {% else %}
      <button type="button"
              class="btn btn-primary btn-sm"
              onclick="document.getElementById('fileInput{{ loop.index }}').click();">
        Upload
      </button>
    {% endif %}
  </div>

  <!-- Hidden File Input Form -->
  <form id="uploadForm{{ loop.index }}" enctype="multipart/form-data" style="display:none;">
    <input type="file" name="official_report" id="fileInput{{ loop.index }}">
  </form>

  <!-- Upload Script -->
  <script>
    document.getElementById('fileInput{{ loop.index }}').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      // Optional: Check file size before upload (max 5MB)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File is too large. Max size is 5MB.');
        return;
      }

      const formData = new FormData();
      formData.append('official_report', file, file.name);

      fetch('{{ url_for("upload_report", report_id=agg.summary.id) }}', {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('uploadStatus{{ loop.index }}').innerHTML = `
              <div class="btn-group" role="group">
                <a href="${data.download_url}" class="btn btn-success btn-sm" download>Download</a>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('fileInput{{ loop.index }}').click();">
                  <i class="bi bi-pencil"></i>
                </button>
              </div>
            `;
          } else {
            alert('Upload failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          alert('Upload error: ' + err);
        });
    });
  </script>
</td>


<!-- Action Column -->
<td>
<button type="button" class="btn btn-danger btn-sm trash-btn" data-summary-id="{{ agg.summary.id }}" data-row-index="{{ loop.index }}">
<i class="bi bi-trash"></i>
</button>
</td>
</tr>
{% endfor %}
</tbody>
</table>

{% else %}
<p>No inspections recorded.</p>
{% endif %}

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Filter logic
const inspectionTypeSelect = document.getElementById('inspectionType');
const regionSelect = document.getElementById('region');
const districtSelect = document.getElementById('district');
const resultBadge = document.getElementById("resultCount");

function filterTable(){
  const inspType = inspectionTypeSelect.value.toLowerCase();
  const region = regionSelect.value.toLowerCase();
  const district = districtSelect.value.toLowerCase();
  const rows = document.querySelectorAll('table tbody tr');
  rows.forEach(row=>{
    const rowType = row.cells[2]?.textContent.toLowerCase()||"";
    const rowRegion = row.cells[3]?.textContent.toLowerCase()||"";
    const rowDistrict = row.cells[4]?.textContent.toLowerCase()||"";
    row.style.display=( (inspType===""||rowType===inspType) && (region===""||rowRegion===region) && (district===""||rowDistrict===district) )?"":"none";
  });
  const visibleCount = Array.from(rows).filter(r=>r.style.display!=="none").length;
  if(inspType||region||district){
    resultBadge.style.display="inline-block";
    resultBadge.textContent=`Total Results: ${visibleCount}`;
    resultBadge.classList.remove("bg-primary","bg-success","bg-danger");
    resultBadge.classList.add(visibleCount===0?"bg-danger":"bg-success");
  }else{resultBadge.style.display="none";}
}

regionSelect.addEventListener('change',function(){
  const sel=this.value.toLowerCase();
  districtSelect.querySelectorAll('option').forEach(opt=>{
    if(opt.value===""||opt.dataset.region.toLowerCase()===sel){opt.style.display="";}else{opt.style.display="none";}
  });
  districtSelect.value="";filterTable();
});
inspectionTypeSelect.addEventListener('change',filterTable);
districtSelect.addEventListener('change',filterTable);
document.getElementById('resetFilter').addEventListener('click',function(){
  inspectionTypeSelect.value="";regionSelect.value="";districtSelect.value="";
  districtSelect.querySelectorAll('option').forEach(opt=>opt.style.display="");
  filterTable();
});
filterTable();

// Delete inspection
document.querySelectorAll('.trash-btn').forEach(btn=>{
  btn.addEventListener('click',function(){
    const summaryId=this.dataset.summaryId;
    const rowIndex=this.dataset.rowIndex;
    if(!confirm('Delete this inspection and all its data?')) return;
    fetch(`/delete_inspection/${summaryId}`,{method:'DELETE'}).then(res=>res.json()).then(data=>{
      if(data.success){const row=document.querySelector('table tbody tr:nth-child('+rowIndex+')');if(row) row.remove();alert('Inspection deleted.');}else{alert('Failed: '+(data.error||'Unknown'));}
    }).catch(err=>alert('Error: '+err));
  });
});
</script>
</body>
</html>
