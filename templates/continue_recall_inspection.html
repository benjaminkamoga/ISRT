<!DOCTYPE html>
<html>
<head>
    <title>Recall Inspection Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body, html { margin:0; padding:0; font-family: Arial, sans-serif; background:#f5f5f5; color:#333;}
        .main-content { padding:20px 40px; min-height:100vh; background:#fefefe; max-width:900px; margin:0 auto;}
        .header { background:#4CAF50; color:white; padding:15px 25px; border-radius:5px; margin-bottom:20px;}
        .card { background:white; padding:20px; margin-bottom:20px; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.05);}
        .premises-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:15px;}
        label { display:block; margin:10px 0 5px; font-weight:bold; color:#2e7d32; }
        input { padding:8px; border:1px solid #ccc; border-radius:4px; width:100%; box-sizing:border-box; font-size:14px; }
        input[type="date"] { max-width:200px; }
        button { background:#4CAF50; color:white; border:none; padding:10px 15px; margin:5px 5px 0 0; border-radius:4px; cursor:pointer; font-weight:600; transition:background 0.3s ease; opacity:0.5; }
        button:hover:not(:disabled){ background:#388e3c; }
        button.cancel-btn{ background:#6c757d; opacity:1; }
        button.cancel-btn:hover{ background:#565e64; }
        button.danger-btn{ background:#d32f2f; opacity:0.5; }
        button.danger-btn:hover:not(:disabled){ background:#a52828; }
        ul.list-group{ max-height:200px; overflow-y:auto; }
        /* Modal CSS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;}
        .modal-content { background: #fff; padding: 20px 30px; border-radius: 8px; max-width: 600px; width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; z-index: 10001; }
        .modal-content button { margin: 10px 5px 0 5px; padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: 600; background: #4CAF50; color: white; transition: background 0.3s ease; }
        .modal-content button:hover { background: #388e3c; }
        .modal-content .cancel-btn { background: #6c757d; }
        .modal-content .cancel-btn:hover { background: #565e64; }
        .product-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin-bottom:10px;}
        .product-row { margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;}
    </style>
</head>
<body>
<div class="main-content">
    <input type="hidden" id="region" value="{{ region|default('') }}">
    <input type="hidden" id="district" value="{{ district|default('') }}">
    <input type="hidden" id="inspectionType" value="{{ inspection_type|default('') }}">
    <input type="hidden" id="inspectionName" value="{{ inspection_name|default('') }}">

    <div class="header">
        <h1>Recall Inspection</h1>
        <p>Region: <span id="regionDisplay">{{ region }}</span> | District: <span id="districtDisplay">{{ district }}</span></p>
    </div>

   <div class="card">
    <h2>Inspection Date</h2>
    <div style="display:flex; align-items:center; gap:10px;">
        <input type="date" id="inspectionDate" required>
    </div>
</div>



    <div class="card">
        <h2>Premises Inspected</h2>
        <div class="premises-grid">
            {% for category in categories %}
            <div>
                <label>{{ category }}:</label>
                <input type="number" min="0" id="prem-{{ loop.index0 }}" data-category="{{ category }}">
            </div>
            {% endfor %}
        </div>
        <p>
            <strong>Total Premises: <span id="totalPremises">0</span></strong> | 
            <strong>Total Premises with Recalled Products: <span id="totalRecalled">0</span></strong>
            <span id="recalledBreakdown"></span>
        </p>
        <p>
            <strong>Total Value of Recalled Products (Tsh): <span id="totalRecalledValue">0</span></strong>
        </p>
    </div>

    <div class="card">
        <h2>Recalled Products (Reference)</h2>
        <div id="productList"></div>
    </div>

    <div class="card d-flex justify-content-start gap-2">
        <button id="saveBtn" onclick="submitInspection()" disabled>Save Inspection</button>
        <button id="saveEndBtn" onclick="submitAndEndInspection()" class="danger-btn" disabled>Save & End Inspection</button>
        <button onclick="window.location.href='/dashboard'" class="cancel-btn">Back to Dashboard</button>
    </div>
</div>

<!-- Modals -->
<div id="recallYesNoModal" class="modal">
    <div class="modal-content">
        <h3>Were recalled products found in <span id="recallCategory"></span>?</h3>
        <button onclick="showCategoryProductModalFromYes()">Yes</button>

        <button onclick="handleRecallNotFound()">No</button>
    </div>
</div>

<!-- Category Product Modal -->
<div id="categoryProductModal" class="modal">
  <div class="modal-content">
    <h3>Products found in <span id="currentCategoryForSelection"></span></h3>

    <table id="categoryProductBatchTable">
      <thead>
        <tr>
          <th>Select</th>
          <th>S/NO</th>
          <th>Brand Name</th>
          <th>Generic Name</th>
          <th>Manufacturer</th>
          <th>MFD</th>
          <th>EXP</th>
          <th>UOM</th>
          <th>Premises with Recalled Product</th>
          <th>Value (Tsh)</th>
          <th>Quantity Recalled</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:20px; text-align:right;">
      <button onclick="saveCategoryProductSelection()">Save</button>
      <button onclick="closeCategoryProductModal(true)" class="cancel-btn">Cancel</button>


    </div>
  </div>
</div>

<style>
/* Modal content */
#categoryProductModal .modal-content {
    border: 2px solid #4CAF50;
    border-radius: 8px;
    padding: 20px;
    background: #fff;
    max-width: 1200px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
}

/* Table styling */
#categoryProductBatchTable, 
#categoryProductBatchTable th, 
#categoryProductBatchTable td {
    border: 1px solid #ccc;
    border-collapse: collapse;
}

#categoryProductBatchTable th, 
#categoryProductBatchTable td {
    padding: 8px;
    text-align: center;
}

/* Header row highlight */
#categoryProductBatchTable thead th {
    background-color: #f0f0f0;
    font-weight: bold;
}

/* Wider date fields */
#categoryProductBatchTable input[type="date"] {
    width: 140px; 
    box-sizing: border-box;
}
</style>

<script>
let recallData = {};
let recalledProducts = [];
let currentCategory = null;
let inspectionName = "";

function showModal(id){ document.querySelectorAll(".modal").forEach(m=>m.style.display="none"); document.getElementById(id).style.display="flex";}
function closeModal(id){ document.getElementById(id).style.display="none"; }


function showCategoryProductModalFromYes() {
    closeModal("recallYesNoModal");
    showCategoryProductModal(currentCategory);
}


function showCategoryProductModal(category) {
    currentCategory = category;
    document.getElementById("currentCategoryForSelection").textContent = category;
    const tbody = document.querySelector("#categoryProductBatchTable tbody");
    tbody.innerHTML = "";

    if (!recalledProducts || recalledProducts.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center">No recalled products</td></tr>`;
    } else {
        recalledProducts.forEach((p, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="checkbox" class="modalProductCheckbox" data-index="${i}"></td>
                <td>${i+1}</td>
                <td>${p.brandName || p.brand || '-'}</td>
                <td>${p.genericName || p.generic || '-'}</td>
                <td>${p.manufacturer || '-'}</td>
                <td><input type="date" value="${(p.batches && p.batches[0]?.manufactureDate) || ''}" disabled></td>
                <td><input type="date" value="${(p.batches && p.batches[0]?.expiryDate) || ''}" disabled></td>
                <td>${p.uom || '-'}</td>
                <td><input type="number" min="0" class="modalPremisesInput" value="0" style="width:80px"></td>
                <td><input type="number" min="0" class="modalValueInput" value="0" style="width:100px"></td>
                <td><input type="number" min="0" class="modalQuantityInput" value="0" style="width:80px"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Show the modal
    document.getElementById("categoryProductModal").style.display = "flex";
}


function handlePremiseChange(input) {
    currentCategory = input.dataset.category;
    const val = parseInt(input.value);

    if (isNaN(val) || val <= 0) {
        // Clear any previous data if input <= 0
        delete recallData[currentCategory];
        updateTotal();
        toggleSaveButtons();
        return;
    }

    // Show Yes/No modal (optional) or directly open category product modal
    document.getElementById("recallCategory").textContent = currentCategory;
    showModal("recallYesNoModal");
}


function showCategoryProductModalFromYes() {
    closeModal("recallYesNoModal");
    showCategoryProductModal(currentCategory);
}

function handleRecallNotFound(){ recallData[currentCategory]={premises_with_recalled:0,value_of_recalled:0,products:[]}; closeAllModals(false); }


function saveCategoryProductSelection() {
    const checkboxes = document.querySelectorAll("#categoryProductBatchTable .modalProductCheckbox");
    const selectedIndexes = [...checkboxes].map((cb, i) => cb.checked ? i : -1).filter(i => i >= 0);

    if (selectedIndexes.length === 0) return alert("Select at least one product");

    const products_found = selectedIndexes.map(i => {
        const tr = checkboxes[i].closest("tr");
        const premises = parseInt(tr.querySelector(".modalPremisesInput").value) || 0;
        const value = parseInt(tr.querySelector(".modalValueInput").value) || 0;
        const quantity = parseInt(tr.querySelector(".modalQuantityInput").value) || 0;

        return {
            product_index: i,
            batch_index: 0,  // If multiple batches, you can loop over them instead
            premises: premises,
            value: value,
            quantity: quantity,
            brandName: recalledProducts[i].brandName || recalledProducts[i].brand || '-',
            genericName: recalledProducts[i].genericName || recalledProducts[i].generic || '-',
            manufacturer: recalledProducts[i].manufacturer || '-',
            reason: recalledProducts[i].reason || '-',
            uom: recalledProducts[i].uom || '-',
            batches: recalledProducts[i].batches || []
        };
    });

    const totalPremises = products_found.reduce((acc, p) => acc + p.premises, 0);
    const totalValue = products_found.reduce((acc, p) => acc + p.value, 0);

    recallData[currentCategory] = {
        total_premises_with_recalled: totalPremises,
        total_value_of_recalled: totalValue,
        products_found: products_found
    };

    closeCategoryProductModal();
    updateTotal();
    toggleSaveButtons();
}


function closeAllModals(cancel=false){ document.querySelectorAll(".modal").forEach(m=>m.style.display="none"); if(cancel&&currentCategory){ delete recallData[currentCategory]; } updateTotal(); toggleSaveButtons(); currentCategory=null; }

function closeCategoryProductModal(cancel=false) {
    document.getElementById("categoryProductModal").style.display = "none";

    if (cancel && currentCategory) {
        // Remove temporary recall data
        delete recallData[currentCategory];

        // Clear premise input in main form
        const categories = JSON.parse('{{ categories|tojson|safe }}');
        categories.forEach((cat, i) => {
            if (cat === currentCategory) {
                const input = document.getElementById("prem-" + i);
                if (input) input.value = "";
            }
        });

        // Update totals and disable save buttons
        updateTotal();
        toggleSaveButtons();
    }

    currentCategory = null;
}


function updateTotal(){
    const categories = JSON.parse('{{ categories|tojson|safe }}');
    let totalPremises = 0, totalRecalled = 0, totalValue = 0;
    let breakdownHtml = [];

    categories.forEach((cat, i) => {
        const val = parseInt(document.getElementById("prem-" + i).value) || 0;
        totalPremises += val;

        const catData = recallData[cat];
        if (catData) {
            totalRecalled += catData.total_premises_with_recalled || 0;
            totalValue += catData.total_value_of_recalled || 0;

            if (catData.products_found && catData.products_found.length > 0) {
                let productBreakdown = catData.products_found.map(p => 
                    `${p.brandName} (${p.premises} prem, Tsh ${p.value})`
                ).join(", ");
                breakdownHtml.push(`${cat}: ${productBreakdown}`);
            } else if (catData.total_premises_with_recalled > 0) {
                breakdownHtml.push(`${cat}: ${catData.total_premises_with_recalled} prem`);
            }
        }
    });

    document.getElementById("totalPremises").textContent = totalPremises;
    document.getElementById("totalRecalled").textContent = totalRecalled;
    document.getElementById("recalledBreakdown").innerHTML = breakdownHtml.length ? `(${breakdownHtml.join("<br>")})` : "";
    document.getElementById("totalRecalledValue").textContent = totalValue;
}



function toggleSaveButtons(){
    const categories=JSON.parse('{{ categories|tojson|safe }}');
    const dateVal=document.getElementById('inspectionDate').value.trim();
    const premisesOk=categories.every((cat,i)=>{ const val=document.getElementById("prem-"+i).value.trim(); return val!==""&&!isNaN(val)&&parseInt(val)>=0; });
    const recalledOk=Object.keys(recallData).length>0;
    const enabled=dateVal&&premisesOk&&recalledOk;
    ['saveBtn','saveEndBtn'].forEach(id=>{ const btn=document.getElementById(id); btn.disabled=!enabled; btn.style.opacity=enabled?"1":"0.5"; });
}

function populateProducts(products){
    const container = document.getElementById("productList");
    container.innerHTML = "";
    recalledProducts = products || [];

    if(recalledProducts.length === 0){
        container.innerHTML = "<p>No recalled products found</p>";
        return;
    }

    recalledProducts.forEach((product, i) => {
        const row = document.createElement("div");
        row.className = "product-row";
        row.innerHTML = `
            <strong>${i+1}. ${product.brandName || product.brand || '-'}</strong>
            <div class="product-grid">
                <div><label>Brand Name</label><input style="width:100%" value="${product.brandName || product.brand || '-'}" disabled></div>
                <div><label>Generic Name</label><input style="width:100%" value="${product.genericName || product.generic || '-'}" disabled></div>
                <div><label>Batch Number</label><input style="width:100%" value="${(product.batches && product.batches[0]?.batchNumber) || '-'}" disabled></div>
                <div><label>Manufacturer</label><input style="width:100%" value="${product.manufacturer || '-'}" disabled></div>
                <div><label>MFD</label><input type="date" style="width:100%" value="${(product.batches && product.batches[0]?.manufactureDate) || ''}" disabled></div>
                <div><label>EXP</label><input type="date" style="width:100%" value="${(product.batches && product.batches[0]?.expiryDate) || ''}" disabled></div>
                <div><label>REASON</label><input style="width:100%" value="${product.reason || '-'}" disabled></div>
                <div><label>UOM</label><input style="width:100%" value="${product.uom || '-'}" disabled></div>
            </div>
        `;
        container.appendChild(row);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const categories = JSON.parse('{{ categories|tojson|safe }}');

    // Attach input listeners for premises
    categories.forEach((cat, i) => {
        const input = document.getElementById("prem-" + i);
        input.addEventListener('input', function() {
            // Allow only numbers
            this.value = this.value.replace(/\D/g, '');
            updateTotal();
            toggleSaveButtons();

            const val = parseInt(this.value);
            if (val > 0) handlePremiseChange(this);
            else {
                delete recallData[this.dataset.category];
                updateTotal();
                toggleSaveButtons();
            }
        });
    });

    // Attach listener for inspection date
    document.getElementById("inspectionDate").addEventListener('input', toggleSaveButtons);

    // Populate recalled products from backend
    const recalledProductsFromBackend = JSON.parse('{{ recalled_products|tojson|safe }}') || [];
    populateProducts(recalledProductsFromBackend);

    // Display totals and toggle save buttons initially
    updateTotal();
    toggleSaveButtons();

    // Display hidden inspection name next to date and update dynamically
    const hiddenInspectionInput = document.getElementById("inspectionName");
    const displayInspectionSpan = document.getElementById("inspectionNameDisplay");
    if (hiddenInspectionInput && displayInspectionSpan) {
        // Initial sync
        displayInspectionSpan.textContent = hiddenInspectionInput.value || "";

        // Dynamic update on input change
        hiddenInspectionInput.addEventListener('input', function() {
            displayInspectionSpan.textContent = hiddenInspectionInput.value || "";
        });
    }

    // Fetch previous inspection data if editing existing inspection
    inspectionName = hiddenInspectionInput.value || "";
    if (inspectionName) {
        fetch(`/api/inspection/get/${inspectionName}`)
            .then(res => res.ok ? res.json() : Promise.reject("Server error"))
            .then(resp => {
                if (resp.success && resp.data) {
                    recallData = resp.data.recall_product_data || {};
                    updateTotal();
                    toggleSaveButtons();
                }
            })
            .catch(err => console.warn("Could not load previous recalled products:", err));
    }
});


function gatherFormData() {
    const inspectionDate = document.getElementById("inspectionDate").value;
    if (!inspectionDate) return null;

    let premisesInspected = {};
    document.querySelectorAll("[id^='prem-']").forEach(input => {
        const category = input.getAttribute("data-category");
        const val = parseInt(input.value);
        premisesInspected[category] = isNaN(val) ? 0 : val;
    });

    

    return {
        inspection_type: document.getElementById("inspectionType").value,
        inspection_date: inspectionDate,
        premises_inspected: premisesInspected,
        defects: {},
        charges: {},
        recall_data: recallData,       // full enriched recall data
        region: document.getElementById("region").value,
        district: document.getElementById("district").value,
        inspection_name: document.getElementById("inspectionName").value || "",
        
    };
}



function submitInspection() {
    const data = gatherFormData();
    if (!data) return alert("Please fill all required fields correctly.");

    data.end = false;

    // Log purename for debugging
    console.log("Submitting inspection with purename:", data.purename);

    fetch("/api/inspection/save", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.ok ? res.json() : Promise.reject("Server rejected request"))
    .then(resp => {
        if (resp.success) {
            alert("Inspection saved successfully");
            if (!inspectionName && resp.inspection_name) inspectionName = resp.inspection_name;
            window.location.href = "/dashboard";
        } else {
            alert("Error saving inspection");
        }
    })
    .catch(err => alert("Server error: " + err));
}

function submitAndEndInspection() {
    const data = gatherFormData();
    if (!data) return alert("Please fill all required fields correctly.");

    data.end = true;

    // Log purename for debugging
    console.log("Submitting and ending inspection with purename:", data.purename);

    fetch("/api/inspection/save", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.ok ? res.json() : Promise.reject("Server rejected request"))
    .then(resp => {
        if (resp.success) {
            alert("Inspection completed successfully");
            window.location.href = "/dashboard";
        } else {
            alert("Error completing inspection");
        }
    })
    .catch(err => alert("Server error: " + err));
}

</script>
</body>
</html>
